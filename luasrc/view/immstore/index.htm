<%+header%>

<style>
* {
    box-sizing: border-box;
}

.immstore-container {
    padding: 20px;
    max-width: 1400px;
    margin: 0 auto;
}

/* å…¼å®¹argonä¸»é¢˜çš„å¡ç‰‡æ ·å¼ */
.cbi-map {
    margin-bottom: 0 !important;
}

/* æ‰©å±•é¡µé¢å®¹å™¨ä¸ºå…¨å®½ï¼Œé¿å…ç±»ä¼¼â€œæ‰‹æœºè§†å›¾â€çš„çª„åˆ— */
.main .container {
    max-width: 100% !important;
    width: 100% !important;
}
.main #content, .main #view, .main .main-right {
    max-width: 100% !important;
    width: 100% !important;
}
.main .container .cbi-map,
.main .container .cbi-section {
    max-width: 100% !important;
    width: 100% !important;
}
.immstore-container {
    max-width: 100% !important; /* æœ¬é¡µå…¨å®½æ˜¾ç¤º */
}

.header-section {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
    padding-bottom: 15px;
    border-bottom: 2px solid var(--border-color, #e0e0e0);
}

.header-section h2 {
    margin: 0;
    font-size: 28px;
    color: inherit;
}

.filter-tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
    align-items: center;
}

.filter-tab {
    padding: 10px 20px;
    background-color: #f5f5f5;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.3s;
    color: #666;
    height: 40px;
    line-height: 20px;
    box-sizing: border-box;
}

.filter-tab:hover {
    background-color: #e8e8e8;
}

.filter-tab.active {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.search-box {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.search-box input {
    flex: 1;
    min-width: 200px;
    max-width: 400px;
    padding: 0 15px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-size: 14px;
    outline: none;
    transition: border-color 0.3s;
    height: 40px;
    box-sizing: border-box;
}

.search-box input:focus {
    border-color: #667eea;
}

.search-stats {
    color: #333;
    font-size: 13px;
    text-shadow: 0 0 8px rgba(255,255,255,0.8);
}

body.dark .search-stats,
.dark .search-stats,
[data-darkmode="1"] .search-stats {
    color: #fff !important;
    text-shadow: 0 0 8px rgba(0,0,0,0.8);
}

.btn-refresh {
    padding: 0 16px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.3s;
    height: 40px;
    line-height: 40px;
    box-sizing: border-box;
    white-space: nowrap;
}

.btn-refresh:hover {
    opacity: 0.9;
    transform: translateY(-1px);
}

.app-card.unavailable {
    opacity: 0.6;
    border-color: #ccc;
}

.unavailable-badge {
    position: absolute;
    top: 10px;
    right: 10px;
    background: #999;
    color: white;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
}

.apps-grid {
    display: grid;
    gap: 20px;
    margin-bottom: 30px;
    grid-template-columns: repeat(2, minmax(240px, 1fr));
}

/* å®½å±æ–­ç‚¹ï¼šé€æ­¥å¢åŠ åˆ—æ•°ï¼Œé¿å…çª„åˆ—å¸ƒå±€ */
@media (min-width: 980px) {
    .apps-grid { grid-template-columns: repeat(3, minmax(240px, 1fr)); }
}
@media (min-width: 1280px) {
    .apps-grid { grid-template-columns: repeat(4, minmax(240px, 1fr)); }
}
@media (min-width: 1600px) {
    .apps-grid { grid-template-columns: repeat(5, minmax(240px, 1fr)); }
}

.app-card {
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 12px;
    padding: 20px;
    transition: all 0.3s;
    cursor: pointer;
    position: relative;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    min-height: 220px;
}

.app-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
    border-color: #667eea;
}

.app-card.installed {
    border-color: #52c41a;
    background: linear-gradient(135deg, #ffffff 0%, #f6ffed 100%);
}

.app-icon {
    font-size: 48px;
    margin-bottom: 12px;
    display: block;
}

.app-name {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 6px;
    color: #333;
}

.app-name-en {
    font-size: 12px;
    color: #999;
    margin-bottom: 10px;
}

.app-desc {
    font-size: 13px;
    color: #666;
    margin-bottom: 15px;
    line-height: 1.5;
    flex: 1;
}

.app-actions {
    margin-top: auto;
}

/* argonæš—é»‘æ¨¡å¼é€‚é… */
body.dark .app-card,
.dark .app-card,
[data-darkmode="1"] .app-card {
    background: #2a2d35 !important;
    border-color: #3a3f4b !important;
}

body.dark .app-card.installed,
.dark .app-card.installed,
[data-darkmode="1"] .app-card.installed {
    background: linear-gradient(135deg, #2a2d35 0%, #1f3a1f 100%) !important;
    border-color: #52c41a !important;
}

body.dark .app-name,
.dark .app-name,
[data-darkmode="1"] .app-name {
    color: #e8e8e8 !important;
}

body.dark .app-name-en,
.dark .app-name-en,
[data-darkmode="1"] .app-name-en {
    color: #aaa !important;
}

body.dark .app-desc,
.dark .app-desc,
[data-darkmode="1"] .app-desc {
    color: #b8b8b8 !important;
}

body.dark .filter-tab,
.dark .filter-tab,
[data-darkmode="1"] .filter-tab {
    background-color: #2a2d35 !important;
    color: #aaa !important;
}

body.dark .filter-tab:hover,
.dark .filter-tab:hover,
[data-darkmode="1"] .filter-tab:hover {
    background-color: #3a3f4b !important;
}

body.dark .header-section,
.dark .header-section,
[data-darkmode="1"] .header-section {
    border-bottom-color: #3a3f4b !important;
}

/* ç³»ç»Ÿçº§æš—é»‘æ¨¡å¼ */
@media (prefers-color-scheme: dark) {
    .app-card {
        background: #2a2d35 !important;
        border-color: #3a3f4b !important;
    }
    
    .app-card.installed {
        background: linear-gradient(135deg, #2a2d35 0%, #1f3a1f 100%) !important;
    }
    
    .app-name {
        color: #e8e8e8 !important;
    }
    
    .app-name-en {
        color: #aaa !important;
    }
    
    .app-desc {
        color: #b8b8b8 !important;
    }
    
    .filter-tab {
        background-color: #2a2d35 !important;
        color: #aaa !important;
    }
    
    .filter-tab:hover {
        background-color: #3a3f4b !important;
    }
    
    .header-section {
        border-bottom-color: #3a3f4b !important;
    }
}

.app-actions {
    display: flex;
    gap: 8px;
}

.btn {
    flex: 1;
    padding: 8px 16px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 500;
    transition: all 0.3s;
}

.btn-install {
    background: linear-gradient(135deg, #52c41a 0%, #73d13d 100%);
    color: white;
}

.btn-install:hover {
    background: linear-gradient(135deg, #389e0d 0%, #52c41a 100%);
}

.btn-remove {
    background: linear-gradient(135deg, #ff4d4f 0%, #ff7875 100%);
    color: white;
}

.btn-remove:hover {
    background: linear-gradient(135deg, #cf1322 0%, #ff4d4f 100%);
}

.btn:disabled {
    background: #d9d9d9;
    cursor: not-allowed;
    opacity: 0.6;
}

.installed-badge {
    position: absolute;
    top: 10px;
    right: 10px;
    background: #52c41a;
    color: white;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
}

.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}

.loading-overlay.show {
    display: flex;
}

.loading-content {
    background: white;
    padding: 30px 40px;
    border-radius: 12px;
    text-align: center;
    max-width: 400px;
}

.spinner {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #667eea;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: spin 1s linear infinite;
    margin: 0 auto 15px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.loading-text {
    font-size: 16px;
    color: #333;
    margin-top: 10px;
}

.toast {
    position: fixed;
    top: 20px;
    right: 20px;
    background: white;
    padding: 16px 24px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    display: none;
    z-index: 10000;
    min-width: 300px;
    animation: slideIn 0.3s;
}

@keyframes slideIn {
    from {
        transform: translateX(400px);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

.toast.show {
    display: block;
}

.toast.success {
    border-left: 4px solid #52c41a;
}

.toast.error {
    border-left: 4px solid #ff4d4f;
}

.toast-title {
    font-weight: 600;
    margin-bottom: 5px;
    font-size: 14px;
}

.toast-message {
    font-size: 13px;
    color: #666;
}

.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #999;
}

.empty-state-icon {
    font-size: 64px;
    margin-bottom: 15px;
}

.empty-state-text {
    font-size: 16px;
}

.log-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.6);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 10000;
    backdrop-filter: blur(3px);
}

.log-modal.show {
    display: flex;
}

.log-modal-content {
    background: white;
    border-radius: 12px;
    width: 90%;
    max-width: 800px;
    max-height: 80vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
}

.log-modal-header {
    padding: 20px 25px;
    border-bottom: 2px solid #e0e0e0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.log-modal-title {
    font-size: 18px;
    font-weight: 600;
    color: inherit;
}

.log-modal-close {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #999;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.3s;
}

.log-modal-close:hover {
    background: #f5f5f5;
    color: #333;
}

.log-modal-body {
    padding: 20px 25px;
    overflow-y: auto;
    flex: 1;
}

.log-content {
    background: #1e1e1e;
    color: #d4d4d4;
    padding: 15px;
    border-radius: 6px;
    font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
    font-size: 13px;
    line-height: 1.6;
    overflow-x: auto;
    white-space: pre-wrap;
    word-wrap: break-word;
}

.log-content.installing {
    position: relative;
}

.log-content.installing::after {
    content: 'â–Š';
    animation: blink 1s infinite;
}

@keyframes blink {
    0%, 50% { opacity: 1; }
    51%, 100% { opacity: 0; }
}

.log-success {
    color: #52c41a;
    font-weight: 600;
}

.log-error {
    color: #ff4d4f;
    font-weight: 600;
}

.log-info {
    color: #1890ff;
}

.log-modal-footer {
    padding: 15px 25px;
    border-top: 1px solid #e0e0e0;
    display: flex;
    justify-content: flex-end;
}

/* Edit Modal Styles */
.edit-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    z-index: 1000;
    justify-content: center;
    align-items: center;
}

.edit-modal.show {
    display: flex;
}

.edit-modal-content {
    background: white;
    border-radius: 12px;
    width: 90%;
    max-width: 500px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
}

.edit-modal-header {
    padding: 20px;
    border-bottom: 1px solid #e0e0e0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.edit-modal-title {
    font-size: 18px;
    font-weight: 600;
}

.edit-modal-close {
    background: none;
    border: none;
    font-size: 20px;
    cursor: pointer;
    color: #999;
}

.edit-modal-body {
    padding: 20px;
}

.edit-form-group {
    margin-bottom: 16px;
}

.edit-form-group label {
    display: block;
    margin-bottom: 6px;
    font-weight: 500;
    color: #333;
}

.edit-form-group input,
.edit-form-group select {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #d9d9d9;
    border-radius: 6px;
    font-size: 14px;
    box-sizing: border-box;
}

.edit-form-group input:focus,
.edit-form-group select:focus {
    border-color: #667eea;
    outline: none;
}

.icon-selector {
    border: 1px solid #d9d9d9;
    border-radius: 6px;
    padding: 12px;
}

.icon-preview {
    font-size: 48px;
    text-align: center;
    padding: 10px;
    background: #f5f5f5;
    border-radius: 8px;
    margin-bottom: 10px;
}

.icon-preview img {
    width: 48px;
    height: 48px;
    object-fit: contain;
}

.icon-options {
    display: flex;
    gap: 8px;
    margin-bottom: 10px;
}

.icon-tab {
    flex: 1;
    padding: 8px;
    border: 1px solid #d9d9d9;
    background: #f5f5f5;
    border-radius: 4px;
    cursor: pointer;
    font-size: 13px;
}

.icon-tab.active {
    background: #667eea;
    color: white;
    border-color: #667eea;
}

.icon-grid {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: 8px;
}

.icon-item {
    font-size: 24px;
    text-align: center;
    padding: 8px;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.2s;
}

.icon-item:hover {
    background: #e6f7ff;
}

.icon-item.selected {
    background: #667eea;
    border-radius: 6px;
}

.icon-url {
    display: flex;
    gap: 8px;
}

.icon-url input {
    flex: 1;
}

.btn-preview-icon {
    padding: 8px 12px;
    background: #667eea;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

.edit-modal-footer {
    padding: 15px 20px;
    border-top: 1px solid #e0e0e0;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
}

.btn-cancel {
    padding: 10px 20px;
    background: #f5f5f5;
    color: #666;
    border: 1px solid #d9d9d9;
    border-radius: 6px;
    cursor: pointer;
}

.btn-save {
    padding: 10px 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
}

/* Dark mode for edit modal */
body.dark .edit-modal-content,
.dark .edit-modal-content,
[data-darkmode="1"] .edit-modal-content {
    background: #2a2d35 !important;
}

body.dark .edit-modal-header,
.dark .edit-modal-header,
[data-darkmode="1"] .edit-modal-header {
    border-color: #3a3f4b !important;
}

body.dark .edit-modal-title,
.dark .edit-modal-title,
[data-darkmode="1"] .edit-modal-title {
    color: #e8e8e8 !important;
}

body.dark .edit-form-group label,
.dark .edit-form-group label,
[data-darkmode="1"] .edit-form-group label {
    color: #ccc !important;
}

body.dark .edit-form-group input,
body.dark .edit-form-group select,
.dark .edit-form-group input,
.dark .edit-form-group select,
[data-darkmode="1"] .edit-form-group input,
[data-darkmode="1"] .edit-form-group select {
    background: #1e2128 !important;
    border-color: #3a3f4b !important;
    color: #e8e8e8 !important;
}

body.dark .icon-selector,
.dark .icon-selector,
[data-darkmode="1"] .icon-selector {
    border-color: #3a3f4b !important;
}

body.dark .icon-preview,
.dark .icon-preview,
[data-darkmode="1"] .icon-preview {
    background: #1e2128 !important;
}

.log-close-btn {
    padding: 8px 24px;
    background: #667eea;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.3s;
}

.log-close-btn:hover {
    background: #5568d3;
}
</style>

<div class="immstore-container">
    <div class="header-section">
        <h2>ğŸ“¦ åº”ç”¨å•†åº—</h2>
    </div>

    <div class="filter-tabs">
        <div class="filter-tab active" data-category="all" onclick="filterApps('all')">
            å…¨éƒ¨åº”ç”¨
        </div>
        <div class="filter-tab" data-category="builtin" onclick="filterApps('builtin')">
            ç²¾é€‰åº”ç”¨
        </div>
        <div class="filter-tab" data-category="system" onclick="filterApps('system')">
            ç³»ç»Ÿå·¥å…·
        </div>
        <div class="filter-tab" data-category="network" onclick="filterApps('network')">
            ç½‘ç»œæœåŠ¡
        </div>
        <div class="filter-tab" data-category="nas" onclick="filterApps('nas')">
            NAS
        </div>
        <div class="filter-tab" data-category="services" onclick="filterApps('services')">
            æœåŠ¡
        </div>
        <div class="filter-tab" data-category="other" onclick="filterApps('other')">
            æ›´å¤šåº”ç”¨
        </div>
    </div>
    
    <div class="search-box">
        <input type="text" id="search-input" placeholder="æœç´¢åº”ç”¨..." oninput="searchApps(this.value)">
        <button class="btn btn-refresh" onclick="refreshApps()">ğŸ”„ åˆ·æ–°åˆ—è¡¨</button>
        <span class="search-stats" id="search-stats"></span>
    </div>

    <div class="apps-grid" id="apps-grid">
        <!-- åº”ç”¨å¡ç‰‡å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loading-overlay">
    <div class="loading-content">
        <div class="spinner"></div>
        <div class="loading-text" id="loading-text">æ­£åœ¨å¤„ç†...</div>
    </div>
</div>

<!-- Toast Notification -->
<div class="toast" id="toast">
    <div class="toast-title" id="toast-title"></div>
    <div class="toast-message" id="toast-message"></div>
</div>

<!-- Edit Modal -->
<div class="edit-modal" id="edit-modal">
    <div class="edit-modal-content">
        <div class="edit-modal-header">
            <div class="edit-modal-title">ç¼–è¾‘åº”ç”¨ä¿¡æ¯</div>
            <button class="edit-modal-close" onclick="closeEditModal()">âœ•</button>
        </div>
        <div class="edit-modal-body">
            <input type="hidden" id="edit-app-id">
            <div class="edit-form-group">
                <label>åº”ç”¨åç§°</label>
                <input type="text" id="edit-app-name" placeholder="ä¸­æ–‡åç§°">
            </div>
            <div class="edit-form-group">
                <label>è‹±æ–‡åç§°</label>
                <input type="text" id="edit-app-name-en" placeholder="English Name">
            </div>
            <div class="edit-form-group">
                <label>åº”ç”¨æè¿°</label>
                <input type="text" id="edit-app-desc" placeholder="åº”ç”¨æè¿°">
            </div>
            <div class="edit-form-group">
                <label>åº”ç”¨å›¾æ ‡</label>
                <div class="icon-selector">
                    <div class="icon-preview" id="icon-preview">ğŸ“¦</div>
                    <div class="icon-options">
                        <button type="button" class="icon-tab active" onclick="switchIconTab('builtin')">å†…ç½®å›¾æ ‡</button>
                        <button type="button" class="icon-tab" onclick="switchIconTab('url')">å¤–éƒ¨URL</button>
                    </div>
                    <div class="icon-builtin" id="icon-builtin">
                        <div class="icon-grid">
                            <span class="icon-item" onclick="selectIcon('ğŸ¨')">ğŸ¨</span>
                            <span class="icon-item" onclick="selectIcon('ğŸŒ')">ğŸŒ</span>
                            <span class="icon-item" onclick="selectIcon('ğŸ”§')">ğŸ”§</span>
                            <span class="icon-item" onclick="selectIcon('ğŸ“')">ğŸ“</span>
                            <span class="icon-item" onclick="selectIcon('ğŸ’¾')">ğŸ’¾</span>
                            <span class="icon-item" onclick="selectIcon('ğŸ”’')">ğŸ”’</span>
                            <span class="icon-item" onclick="selectIcon('ğŸš€')">ğŸš€</span>
                            <span class="icon-item" onclick="selectIcon('âš¡')">âš¡</span>
                            <span class="icon-item" onclick="selectIcon('ğŸ®')">ğŸ®</span>
                            <span class="icon-item" onclick="selectIcon('ğŸ“Š')">ğŸ“Š</span>
                            <span class="icon-item" onclick="selectIcon('ğŸ””')">ğŸ””</span>
                            <span class="icon-item" onclick="selectIcon('ğŸ“¡')">ğŸ“¡</span>
                            <span class="icon-item" onclick="selectIcon('ğŸ–¥ï¸')">ğŸ–¥ï¸</span>
                            <span class="icon-item" onclick="selectIcon('ğŸ“¦')">ğŸ“¦</span>
                            <span class="icon-item" onclick="selectIcon('ğŸ³')">ğŸ³</span>
                            <span class="icon-item" onclick="selectIcon('â˜ï¸')">â˜ï¸</span>
                            <span class="icon-item" onclick="selectIcon('ğŸ”¥')">ğŸ”¥</span>
                            <span class="icon-item" onclick="selectIcon('ğŸ’¡')">ğŸ’¡</span>
                            <span class="icon-item" onclick="selectIcon('ğŸµ')">ğŸµ</span>
                            <span class="icon-item" onclick="selectIcon('ğŸ“¹')">ğŸ“¹</span>
                            <span class="icon-item" onclick="selectIcon('ğŸ›¡ï¸')">ğŸ›¡ï¸</span>
                            <span class="icon-item" onclick="selectIcon('â¬‡ï¸')">â¬‡ï¸</span>
                            <span class="icon-item" onclick="selectIcon('ğŸŒ™')">ğŸŒ™</span>
                            <span class="icon-item" onclick="selectIcon('â˜€ï¸')">â˜€ï¸</span>
                        </div>
                    </div>
                    <div class="icon-url" id="icon-url" style="display:none;">
                        <input type="text" id="edit-icon-url" placeholder="è¾“å…¥å›¾æ ‡URL (å¦‚: https://example.com/icon.png)">
                        <button type="button" class="btn-preview-icon" onclick="previewIconUrl()">é¢„è§ˆ</button>
                    </div>
                </div>
            </div>
            <div class="edit-form-group">
                <label>åˆ†ç±»</label>
                <select id="edit-app-category">
                    <option value="system">ç³»ç»Ÿå·¥å…·</option>
                    <option value="network">ç½‘ç»œæœåŠ¡</option>
                    <option value="nas">NAS</option>
                    <option value="services">æœåŠ¡</option>
                    <option value="other">å…¶ä»–</option>
                </select>
            </div>
        </div>
        <div class="edit-modal-footer">
            <button class="btn btn-cancel" onclick="closeEditModal()">å–æ¶ˆ</button>
            <button class="btn btn-save" onclick="saveAppEdit()">ä¿å­˜</button>
        </div>
    </div>
</div>

<!-- Log Modal -->
<div class="log-modal" id="log-modal">
    <div class="log-modal-content">
        <div class="log-modal-header">
            <div class="log-modal-title" id="log-modal-title">å®‰è£…æ—¥å¿—</div>
            <button class="log-modal-close" onclick="closeLogModal()">âœ•</button>
        </div>
        <div class="log-modal-body">
            <div class="log-content" id="log-content"></div>
        </div>
        <div class="log-modal-footer">
            <button class="log-close-btn" onclick="closeLogModal()">å…³é—­</button>
        </div>
    </div>
</div>

<script>
let allApps = [];
let currentCategory = 'all';
let searchKeyword = '';
let currentEditApp = null;
let currentIconType = 'builtin';
let selectedIcon = 'ğŸ“¦';

// ç¼–è¾‘åº”ç”¨ä¿¡æ¯
function openEditModal(appId, event) {
    if (event) event.stopPropagation();
    
    const app = allApps.find(a => a.id === appId);
    if (!app) return;
    
    currentEditApp = app;
    document.getElementById('edit-app-id').value = app.id;
    document.getElementById('edit-app-name').value = app.name || '';
    document.getElementById('edit-app-name-en').value = app.name_en || '';
    document.getElementById('edit-app-desc').value = app.description || '';
    document.getElementById('edit-app-category').value = app.category || 'other';
    
    // è®¾ç½®å›¾æ ‡
    if (app.icon && app.icon.startsWith('http')) {
        currentIconType = 'url';
        document.getElementById('edit-icon-url').value = app.icon;
        document.getElementById('icon-preview').innerHTML = '<img src="' + app.icon + '" onerror="this.parentElement.textContent=\'ğŸ“¦\'">';
        switchIconTab('url');
    } else {
        currentIconType = 'builtin';
        selectedIcon = app.icon || 'ğŸ“¦';
        document.getElementById('icon-preview').textContent = selectedIcon;
        switchIconTab('builtin');
    }
    
    document.getElementById('edit-modal').classList.add('show');
}

function closeEditModal() {
    document.getElementById('edit-modal').classList.remove('show');
    currentEditApp = null;
}

function switchIconTab(type) {
    currentIconType = type;
    document.querySelectorAll('.icon-tab').forEach(tab => tab.classList.remove('active'));
    document.querySelector('.icon-tab[onclick*="' + type + '"]').classList.add('active');
    
    if (type === 'builtin') {
        document.getElementById('icon-builtin').style.display = 'block';
        document.getElementById('icon-url').style.display = 'none';
    } else {
        document.getElementById('icon-builtin').style.display = 'none';
        document.getElementById('icon-url').style.display = 'flex';
    }
}

function selectIcon(icon) {
    selectedIcon = icon;
    document.getElementById('icon-preview').textContent = icon;
    document.querySelectorAll('.icon-item').forEach(item => item.classList.remove('selected'));
    event.target.classList.add('selected');
}

function previewIconUrl() {
    const url = document.getElementById('edit-icon-url').value.trim();
    if (url) {
        document.getElementById('icon-preview').innerHTML = '<img src="' + url + '" onerror="this.parentElement.textContent=\'âŒ\'">';
    }
}

function saveAppEdit() {
    const appId = document.getElementById('edit-app-id').value;
    const name = document.getElementById('edit-app-name').value.trim();
    const nameEn = document.getElementById('edit-app-name-en').value.trim();
    const desc = document.getElementById('edit-app-desc').value.trim();
    const category = document.getElementById('edit-app-category').value;
    
    let icon;
    if (currentIconType === 'url') {
        icon = document.getElementById('edit-icon-url').value.trim() || 'ğŸ“¦';
    } else {
        icon = selectedIcon || 'ğŸ“¦';
    }
    
    // å‘é€ä¿å­˜è¯·æ±‚
    showLoading('æ­£åœ¨ä¿å­˜...');
    
    XHR.get('<%=url("admin/immstore/save_app_edit")%>', {
        app_id: appId,
        name: name,
        name_en: nameEn,
        description: desc,
        icon: icon,
        category: category
    }, function(xhr, data) {
        hideLoading();
        
        if (data && data.code === 0) {
            // æ›´æ–°æœ¬åœ°æ•°æ®
            const app = allApps.find(a => a.id === appId);
            if (app) {
                if (name) app.name = name;
                if (nameEn) app.name_en = nameEn;
                if (desc) app.description = desc;
                app.icon = icon;
                app.category = category;
            }
            renderApps();
            closeEditModal();
            showToast('ä¿å­˜æˆåŠŸ', 'åº”ç”¨ä¿¡æ¯å·²æ›´æ–°', 'success');
        } else {
            showToast('ä¿å­˜å¤±è´¥', data ? data.message : 'æœªçŸ¥é”™è¯¯', 'error');
        }
    });
}

// æ˜¾ç¤ºToasté€šçŸ¥
function showToast(title, message, type) {
    const toast = document.getElementById('toast');
    const toastTitle = document.getElementById('toast-title');
    const toastMessage = document.getElementById('toast-message');
    
    toastTitle.textContent = title;
    toastMessage.textContent = message;
    toast.className = 'toast show ' + type;
    
    setTimeout(() => {
        toast.classList.remove('show');
    }, 3000);
}

// æ˜¾ç¤º/éšè—åŠ è½½çŠ¶æ€
function showLoading(text) {
    document.getElementById('loading-text').textContent = text;
    document.getElementById('loading-overlay').classList.add('show');
}

function hideLoading() {
    document.getElementById('loading-overlay').classList.remove('show');
}

// æ˜¾ç¤ºæ—¥å¿—æ¨¡æ€æ¡†
function showLogModal(title, content, isInstalling) {
    document.getElementById('log-modal-title').textContent = title;
    const logContent = document.getElementById('log-content');
    logContent.textContent = content;
    if (isInstalling) {
        logContent.classList.add('installing');
    } else {
        logContent.classList.remove('installing');
    }
    document.getElementById('log-modal').classList.add('show');
}

// å…³é—­æ—¥å¿—æ¨¡æ€æ¡†
function closeLogModal() {
    document.getElementById('log-modal').classList.remove('show');
}

// åŠ è½½åº”ç”¨åˆ—è¡¨
function loadApps() {
    showLoading('æ­£åœ¨åŠ è½½åº”ç”¨åˆ—è¡¨...');
    
    XHR.get('<%=url("admin/immstore/get_apps")%>', null, function(xhr, data) {
        hideLoading();
        
        if (data && data.code === 0) {
            allApps = data.apps;
            updateStats(data);
            renderApps();
        } else {
            showToast('é”™è¯¯', 'åŠ è½½åº”ç”¨åˆ—è¡¨å¤±è´¥', 'error');
        }
    });
}

// æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
function updateStats(data) {
    const stats = document.getElementById('search-stats');
    if (stats && data) {
        let text = 'å…± ' + data.total + ' ä¸ªåº”ç”¨ (ç²¾é€‰ ' + data.builtin_count + ' / æ›´å¤š ' + data.dynamic_count + ')';
        if (data.updated_at) {
            const date = new Date(data.updated_at * 1000);
            text += ' | æ›´æ–°äº ' + date.toLocaleString('zh-CN');
        }
        stats.textContent = text;
    }
}

// åˆ·æ–°åº”ç”¨åˆ—è¡¨ï¼ˆä»è½¯ä»¶æºé‡æ–°è·å–ï¼‰
function refreshApps() {
    showLoading('æ­£åœ¨åˆ·æ–°åº”ç”¨åˆ—è¡¨...');
    
    XHR.get('<%=url("admin/immstore/refresh_apps")%>', null, function(xhr, data) {
        hideLoading();
        
        if (data && data.code === 0) {
            allApps = data.apps;
            updateStats(data);
            renderApps();
            showToast('åˆ·æ–°æˆåŠŸ', 'å·²ä»è½¯ä»¶æºè·å– ' + data.total + ' ä¸ªåº”ç”¨', 'success');
        } else {
            showToast('é”™è¯¯', 'åˆ·æ–°åº”ç”¨åˆ—è¡¨å¤±è´¥', 'error');
        }
    });
}

// æœç´¢åº”ç”¨
function searchApps(keyword) {
    searchKeyword = keyword.toLowerCase().trim();
    renderApps();
}

// æ¸²æŸ“åº”ç”¨å¡ç‰‡
function renderApps() {
    const grid = document.getElementById('apps-grid');
    
    // å…ˆæŒ‰åˆ†ç±»ç­›é€‰
    let filteredApps = allApps;
    if (currentCategory === 'builtin') {
        filteredApps = allApps.filter(app => app.builtin === true);
    } else if (currentCategory === 'other') {
        filteredApps = allApps.filter(app => app.builtin === false);
    } else if (currentCategory !== 'all') {
        filteredApps = allApps.filter(app => app.category === currentCategory);
    }
    
    // å†æŒ‰å…³é”®è¯æœç´¢
    if (searchKeyword) {
        filteredApps = filteredApps.filter(app => 
            app.name.toLowerCase().includes(searchKeyword) ||
            app.name_en.toLowerCase().includes(searchKeyword) ||
            app.id.toLowerCase().includes(searchKeyword) ||
            (app.description && app.description.toLowerCase().includes(searchKeyword))
        );
    }
    
    // éšè—è½¯ä»¶æºä¸­ä¸å­˜åœ¨çš„å†…ç½®åº”ç”¨ï¼ˆé™¤éå·²å®‰è£…ï¼‰
    filteredApps = filteredApps.filter(app => app.available !== false || app.installed);
    
    if (filteredApps.length === 0) {
        grid.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“­</div><div class="empty-state-text">æš‚æ— åº”ç”¨</div></div>';
        return;
    }
    
    grid.innerHTML = filteredApps.map(app => {
        // å¤„ç†å›¾æ ‡æ˜¾ç¤ºï¼šæ”¯æŒ emoji å’Œ URL
        let iconHtml;
        if (app.icon && app.icon.startsWith('http')) {
            iconHtml = '<img src="' + app.icon + '" style="width:48px;height:48px;object-fit:contain;" onerror="this.parentElement.textContent=\'ğŸ“¦\'">';
        } else {
            iconHtml = app.icon || 'ğŸ“¦';
        }
        
        return `
        <div class="app-card ${app.installed ? 'installed' : ''}" data-id="${app.id}" onclick="openEditModal('${app.id}', event)">
            ${app.installed ? '<div class="installed-badge">å·²å®‰è£…</div>' : ''}
            <div class="app-icon">${iconHtml}</div>
            <div class="app-name">${app.name}</div>
            <div class="app-name-en">${app.name_en}</div>
            <div class="app-desc">${app.description}</div>
            <div class="app-actions">
                ${app.installed 
                    ? '<button class="btn btn-remove" onclick="event.stopPropagation();removeApp(\'' + app.id + '\', \'' + (app.package || '') + '\')">å¸è½½</button>'
                    : '<button class="btn btn-install" onclick="event.stopPropagation();installApp(\'' + app.id + '\', \'' + (app.package || '') + '\')">å®‰è£…</button>'
                }
            </div>
        </div>
    `}).join('');
}

// åˆ†ç±»ç­›é€‰
function filterApps(category) {
    currentCategory = category;
    
    // æ›´æ–°æ ‡ç­¾çŠ¶æ€
    document.querySelectorAll('.filter-tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.dataset.category === category) {
            tab.classList.add('active');
        }
    });
    
    renderApps();
}

// å®‰è£…åº”ç”¨
function installApp(appId, pkgName) {
    const app = allApps.find(a => a.id === appId);
    if (!app) return;
    
    if (confirm('ç¡®å®šè¦å®‰è£… ' + app.name + ' å—ï¼Ÿ')) {
        // æ˜¾ç¤ºå®‰è£…ä¸­çš„æ—¥å¿—çª—å£
        showLogModal('æ­£åœ¨å®‰è£… ' + app.name, 'æ­£åœ¨å‡†å¤‡å®‰è£…...\næ£€æŸ¥è½¯ä»¶æºæ›´æ–°çŠ¶æ€...\n', true);
        
        XHR.get('<%=url("admin/immstore/install_app")%>', {app_id: appId, package: pkgName || app.package || appId}, function(xhr, data) {
            if (data && data.code === 0) {
                // æ˜¾ç¤ºæˆåŠŸæ—¥å¿—
                const logText = '=== å®‰è£…æˆåŠŸ ===\n\n' + (data.output || 'å®‰è£…å®Œæˆ');
                showLogModal('å®‰è£…æˆåŠŸ - ' + app.name, logText, false);
                showToast('å®‰è£…æˆåŠŸ', app.name + ' å·²æˆåŠŸå®‰è£…', 'success');
                loadApps(); // é‡æ–°åŠ è½½åˆ—è¡¨
            } else {
                // æ˜¾ç¤ºå¤±è´¥æ—¥å¿—
                const logText = '=== å®‰è£…å¤±è´¥ ===\n\n' + (data.output || data.message || 'æœªçŸ¥é”™è¯¯');
                showLogModal('å®‰è£…å¤±è´¥ - ' + app.name, logText, false);
                showToast('å®‰è£…å¤±è´¥', data ? data.message : 'æœªçŸ¥é”™è¯¯', 'error');
            }
        });
    }
}

// å¸è½½åº”ç”¨
function removeApp(appId, pkgName) {
    const app = allApps.find(a => a.id === appId);
    if (!app) return;
    
    if (confirm('ç¡®å®šè¦å¸è½½ ' + app.name + ' å—ï¼Ÿ')) {
        // æ˜¾ç¤ºå¸è½½ä¸­çš„æ—¥å¿—çª—å£
        showLogModal('æ­£åœ¨å¸è½½ ' + app.name, 'æ­£åœ¨å¸è½½åº”ç”¨...\n', true);
        
        XHR.get('<%=url("admin/immstore/remove_app")%>', {app_id: appId, package: pkgName || app.package || appId}, function(xhr, data) {
            if (data && data.code === 0) {
                // æ˜¾ç¤ºæˆåŠŸæ—¥å¿—
                const logText = '=== å¸è½½æˆåŠŸ ===\n\n' + (data.output || 'å¸è½½å®Œæˆ');
                showLogModal('å¸è½½æˆåŠŸ - ' + app.name, logText, false);
                showToast('å¸è½½æˆåŠŸ', app.name + ' å·²æˆåŠŸå¸è½½', 'success');
                loadApps(); // é‡æ–°åŠ è½½åˆ—è¡¨
            } else {
                // æ˜¾ç¤ºå¤±è´¥æ—¥å¿—
                const logText = '=== å¸è½½å¤±è´¥ ===\n\n' + (data.output || data.message || 'æœªçŸ¥é”™è¯¯');
                showLogModal('å¸è½½å¤±è´¥ - ' + app.name, logText, false);
                showToast('å¸è½½å¤±è´¥', data ? data.message : 'æœªçŸ¥é”™è¯¯', 'error');
            }
        });
    }
}

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
window.addEventListener('load', function() {
    loadApps();
});
</script>

<%+footer%>
