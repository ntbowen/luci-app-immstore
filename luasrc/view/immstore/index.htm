<%+header%>

<style>
* {
    box-sizing: border-box;
}

.immstore-container {
    padding: 20px;
    max-width: 1400px;
    margin: 0 auto;
}

/* å…¼å®¹argonä¸»é¢˜çš„å¡ç‰‡æ ·å¼ */
.cbi-map {
    margin-bottom: 0 !important;
}

.header-section {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
    padding-bottom: 15px;
    border-bottom: 2px solid var(--border-color, #e0e0e0);
}

.header-section h2 {
    margin: 0;
    font-size: 28px;
    color: inherit;
}

.filter-tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 25px;
    flex-wrap: wrap;
}

.filter-tab {
    padding: 8px 20px;
    background-color: #f5f5f5;
    border: 2px solid transparent;
    border-radius: 20px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.3s;
    color: #666;
}

.filter-tab:hover {
    background-color: #e8e8e8;
}

.filter-tab.active {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-color: transparent;
}

.apps-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.app-card {
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 12px;
    padding: 20px;
    transition: all 0.3s;
    cursor: pointer;
    position: relative;
    overflow: hidden;
}

.app-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
    border-color: #667eea;
}

.app-card.installed {
    border-color: #52c41a;
    background: linear-gradient(135deg, #ffffff 0%, #f6ffed 100%);
}

.app-icon {
    font-size: 48px;
    margin-bottom: 12px;
    display: block;
}

.app-name {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 6px;
    color: #333;
}

.app-name-en {
    font-size: 12px;
    color: #999;
    margin-bottom: 10px;
}

.app-desc {
    font-size: 13px;
    color: #666;
    margin-bottom: 15px;
    line-height: 1.5;
    min-height: 40px;
}

/* argonæš—é»‘æ¨¡å¼é€‚é… */
body.dark .app-card,
.dark .app-card,
[data-darkmode="1"] .app-card {
    background: #2a2d35 !important;
    border-color: #3a3f4b !important;
}

body.dark .app-card.installed,
.dark .app-card.installed,
[data-darkmode="1"] .app-card.installed {
    background: linear-gradient(135deg, #2a2d35 0%, #1f3a1f 100%) !important;
    border-color: #52c41a !important;
}

body.dark .app-name,
.dark .app-name,
[data-darkmode="1"] .app-name {
    color: #e8e8e8 !important;
}

body.dark .app-name-en,
.dark .app-name-en,
[data-darkmode="1"] .app-name-en {
    color: #aaa !important;
}

body.dark .app-desc,
.dark .app-desc,
[data-darkmode="1"] .app-desc {
    color: #b8b8b8 !important;
}

body.dark .filter-tab,
.dark .filter-tab,
[data-darkmode="1"] .filter-tab {
    background-color: #2a2d35 !important;
    color: #aaa !important;
}

body.dark .filter-tab:hover,
.dark .filter-tab:hover,
[data-darkmode="1"] .filter-tab:hover {
    background-color: #3a3f4b !important;
}

body.dark .header-section,
.dark .header-section,
[data-darkmode="1"] .header-section {
    border-bottom-color: #3a3f4b !important;
}

/* ç³»ç»Ÿçº§æš—é»‘æ¨¡å¼ */
@media (prefers-color-scheme: dark) {
    .app-card {
        background: #2a2d35 !important;
        border-color: #3a3f4b !important;
    }
    
    .app-card.installed {
        background: linear-gradient(135deg, #2a2d35 0%, #1f3a1f 100%) !important;
    }
    
    .app-name {
        color: #e8e8e8 !important;
    }
    
    .app-name-en {
        color: #aaa !important;
    }
    
    .app-desc {
        color: #b8b8b8 !important;
    }
    
    .filter-tab {
        background-color: #2a2d35 !important;
        color: #aaa !important;
    }
    
    .filter-tab:hover {
        background-color: #3a3f4b !important;
    }
    
    .header-section {
        border-bottom-color: #3a3f4b !important;
    }
}

.app-actions {
    display: flex;
    gap: 8px;
}

.btn {
    flex: 1;
    padding: 8px 16px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 500;
    transition: all 0.3s;
}

.btn-install {
    background: linear-gradient(135deg, #52c41a 0%, #73d13d 100%);
    color: white;
}

.btn-install:hover {
    background: linear-gradient(135deg, #389e0d 0%, #52c41a 100%);
}

.btn-remove {
    background: linear-gradient(135deg, #ff4d4f 0%, #ff7875 100%);
    color: white;
}

.btn-remove:hover {
    background: linear-gradient(135deg, #cf1322 0%, #ff4d4f 100%);
}

.btn:disabled {
    background: #d9d9d9;
    cursor: not-allowed;
    opacity: 0.6;
}

.installed-badge {
    position: absolute;
    top: 10px;
    right: 10px;
    background: #52c41a;
    color: white;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
}

.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}

.loading-overlay.show {
    display: flex;
}

.loading-content {
    background: white;
    padding: 30px 40px;
    border-radius: 12px;
    text-align: center;
    max-width: 400px;
}

.spinner {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #667eea;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: spin 1s linear infinite;
    margin: 0 auto 15px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.loading-text {
    font-size: 16px;
    color: #333;
    margin-top: 10px;
}

.toast {
    position: fixed;
    top: 20px;
    right: 20px;
    background: white;
    padding: 16px 24px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    display: none;
    z-index: 10000;
    min-width: 300px;
    animation: slideIn 0.3s;
}

@keyframes slideIn {
    from {
        transform: translateX(400px);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

.toast.show {
    display: block;
}

.toast.success {
    border-left: 4px solid #52c41a;
}

.toast.error {
    border-left: 4px solid #ff4d4f;
}

.toast-title {
    font-weight: 600;
    margin-bottom: 5px;
    font-size: 14px;
}

.toast-message {
    font-size: 13px;
    color: #666;
}

.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #999;
}

.empty-state-icon {
    font-size: 64px;
    margin-bottom: 15px;
}

.empty-state-text {
    font-size: 16px;
}

.log-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.6);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 10000;
    backdrop-filter: blur(3px);
}

.log-modal.show {
    display: flex;
}

.log-modal-content {
    background: white;
    border-radius: 12px;
    width: 90%;
    max-width: 800px;
    max-height: 80vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
}

.log-modal-header {
    padding: 20px 25px;
    border-bottom: 2px solid #e0e0e0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.log-modal-title {
    font-size: 18px;
    font-weight: 600;
    color: inherit;
}

.log-modal-close {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #999;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.3s;
}

.log-modal-close:hover {
    background: #f5f5f5;
    color: #333;
}

.log-modal-body {
    padding: 20px 25px;
    overflow-y: auto;
    flex: 1;
}

.log-content {
    background: #1e1e1e;
    color: #d4d4d4;
    padding: 15px;
    border-radius: 6px;
    font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
    font-size: 13px;
    line-height: 1.6;
    overflow-x: auto;
    white-space: pre-wrap;
    word-wrap: break-word;
}

.log-content.installing {
    position: relative;
}

.log-content.installing::after {
    content: 'â–Š';
    animation: blink 1s infinite;
}

@keyframes blink {
    0%, 50% { opacity: 1; }
    51%, 100% { opacity: 0; }
}

.log-success {
    color: #52c41a;
    font-weight: 600;
}

.log-error {
    color: #ff4d4f;
    font-weight: 600;
}

.log-info {
    color: #1890ff;
}

.log-modal-footer {
    padding: 15px 25px;
    border-top: 1px solid #e0e0e0;
    display: flex;
    justify-content: flex-end;
}

.log-close-btn {
    padding: 8px 24px;
    background: #667eea;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.3s;
}

.log-close-btn:hover {
    background: #5568d3;
}
</style>

<div class="immstore-container">
    <div class="header-section">
        <h2>ğŸ“¦ åº”ç”¨å•†åº—</h2>
    </div>

    <div class="filter-tabs">
        <div class="filter-tab active" data-category="all" onclick="filterApps('all')">
            å…¨éƒ¨åº”ç”¨
        </div>
        <div class="filter-tab" data-category="system" onclick="filterApps('system')">
            ç³»ç»Ÿå·¥å…·
        </div>
        <div class="filter-tab" data-category="network" onclick="filterApps('network')">
            ç½‘ç»œæœåŠ¡
        </div>
        <div class="filter-tab" data-category="nas" onclick="filterApps('nas')">
            NAS
        </div>
        <div class="filter-tab" data-category="services" onclick="filterApps('services')">
            æœåŠ¡
        </div>
    </div>

    <div class="apps-grid" id="apps-grid">
        <!-- åº”ç”¨å¡ç‰‡å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loading-overlay">
    <div class="loading-content">
        <div class="spinner"></div>
        <div class="loading-text" id="loading-text">æ­£åœ¨å¤„ç†...</div>
    </div>
</div>

<!-- Toast Notification -->
<div class="toast" id="toast">
    <div class="toast-title" id="toast-title"></div>
    <div class="toast-message" id="toast-message"></div>
</div>

<!-- Log Modal -->
<div class="log-modal" id="log-modal">
    <div class="log-modal-content">
        <div class="log-modal-header">
            <div class="log-modal-title" id="log-modal-title">å®‰è£…æ—¥å¿—</div>
            <button class="log-modal-close" onclick="closeLogModal()">âœ•</button>
        </div>
        <div class="log-modal-body">
            <div class="log-content" id="log-content"></div>
        </div>
        <div class="log-modal-footer">
            <button class="log-close-btn" onclick="closeLogModal()">å…³é—­</button>
        </div>
    </div>
</div>

<script>
let allApps = [];
let currentCategory = 'all';

// æ˜¾ç¤ºToasté€šçŸ¥
function showToast(title, message, type) {
    const toast = document.getElementById('toast');
    const toastTitle = document.getElementById('toast-title');
    const toastMessage = document.getElementById('toast-message');
    
    toastTitle.textContent = title;
    toastMessage.textContent = message;
    toast.className = 'toast show ' + type;
    
    setTimeout(() => {
        toast.classList.remove('show');
    }, 3000);
}

// æ˜¾ç¤º/éšè—åŠ è½½çŠ¶æ€
function showLoading(text) {
    document.getElementById('loading-text').textContent = text;
    document.getElementById('loading-overlay').classList.add('show');
}

function hideLoading() {
    document.getElementById('loading-overlay').classList.remove('show');
}

// æ˜¾ç¤ºæ—¥å¿—æ¨¡æ€æ¡†
function showLogModal(title, content, isInstalling) {
    document.getElementById('log-modal-title').textContent = title;
    const logContent = document.getElementById('log-content');
    logContent.textContent = content;
    if (isInstalling) {
        logContent.classList.add('installing');
    } else {
        logContent.classList.remove('installing');
    }
    document.getElementById('log-modal').classList.add('show');
}

// å…³é—­æ—¥å¿—æ¨¡æ€æ¡†
function closeLogModal() {
    document.getElementById('log-modal').classList.remove('show');
}

// åŠ è½½åº”ç”¨åˆ—è¡¨
function loadApps() {
    showLoading('æ­£åœ¨åŠ è½½åº”ç”¨åˆ—è¡¨...');
    
    XHR.get('<%=url("admin/immstore/get_apps")%>', null, function(xhr, data) {
        hideLoading();
        
        if (data && data.code === 0) {
            allApps = data.apps;
            renderApps();
        } else {
            showToast('é”™è¯¯', 'åŠ è½½åº”ç”¨åˆ—è¡¨å¤±è´¥', 'error');
        }
    });
}

// æ¸²æŸ“åº”ç”¨å¡ç‰‡
function renderApps() {
    const grid = document.getElementById('apps-grid');
    const filteredApps = currentCategory === 'all' 
        ? allApps 
        : allApps.filter(app => app.category === currentCategory);
    
    if (filteredApps.length === 0) {
        grid.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“­</div><div class="empty-state-text">æš‚æ— åº”ç”¨</div></div>';
        return;
    }
    
    grid.innerHTML = filteredApps.map(app => `
        <div class="app-card ${app.installed ? 'installed' : ''}" data-id="${app.id}">
            ${app.installed ? '<div class="installed-badge">å·²å®‰è£…</div>' : ''}
            <div class="app-icon">${app.icon}</div>
            <div class="app-name">${app.name}</div>
            <div class="app-name-en">${app.name_en}</div>
            <div class="app-desc">${app.description}</div>
            <div class="app-actions">
                ${app.installed 
                    ? '<button class="btn btn-remove" onclick="removeApp(\'' + app.id + '\')">å¸è½½</button>'
                    : '<button class="btn btn-install" onclick="installApp(\'' + app.id + '\')">å®‰è£…</button>'
                }
            </div>
        </div>
    `).join('');
}

// åˆ†ç±»ç­›é€‰
function filterApps(category) {
    currentCategory = category;
    
    // æ›´æ–°æ ‡ç­¾çŠ¶æ€
    document.querySelectorAll('.filter-tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.dataset.category === category) {
            tab.classList.add('active');
        }
    });
    
    renderApps();
}

// å®‰è£…åº”ç”¨
function installApp(appId) {
    const app = allApps.find(a => a.id === appId);
    if (!app) return;
    
    if (confirm('ç¡®å®šè¦å®‰è£… ' + app.name + ' å—ï¼Ÿ')) {
        // æ˜¾ç¤ºå®‰è£…ä¸­çš„æ—¥å¿—çª—å£
        showLogModal('æ­£åœ¨å®‰è£… ' + app.name, 'æ­£åœ¨å‡†å¤‡å®‰è£…...\næ£€æŸ¥è½¯ä»¶æºæ›´æ–°çŠ¶æ€...\n', true);
        
        XHR.get('<%=url("admin/immstore/install_app")%>', {app_id: appId}, function(xhr, data) {
            if (data && data.code === 0) {
                // æ˜¾ç¤ºæˆåŠŸæ—¥å¿—
                const logText = '=== å®‰è£…æˆåŠŸ ===\n\n' + (data.output || 'å®‰è£…å®Œæˆ');
                showLogModal('å®‰è£…æˆåŠŸ - ' + app.name, logText, false);
                showToast('å®‰è£…æˆåŠŸ', app.name + ' å·²æˆåŠŸå®‰è£…', 'success');
                loadApps(); // é‡æ–°åŠ è½½åˆ—è¡¨
            } else {
                // æ˜¾ç¤ºå¤±è´¥æ—¥å¿—
                const logText = '=== å®‰è£…å¤±è´¥ ===\n\n' + (data.output || data.message || 'æœªçŸ¥é”™è¯¯');
                showLogModal('å®‰è£…å¤±è´¥ - ' + app.name, logText, false);
                showToast('å®‰è£…å¤±è´¥', data ? data.message : 'æœªçŸ¥é”™è¯¯', 'error');
            }
        });
    }
}

// å¸è½½åº”ç”¨
function removeApp(appId) {
    const app = allApps.find(a => a.id === appId);
    if (!app) return;
    
    if (confirm('ç¡®å®šè¦å¸è½½ ' + app.name + ' å—ï¼Ÿ')) {
        // æ˜¾ç¤ºå¸è½½ä¸­çš„æ—¥å¿—çª—å£
        showLogModal('æ­£åœ¨å¸è½½ ' + app.name, 'æ­£åœ¨å¸è½½åº”ç”¨...\n', true);
        
        XHR.get('<%=url("admin/immstore/remove_app")%>', {app_id: appId}, function(xhr, data) {
            if (data && data.code === 0) {
                // æ˜¾ç¤ºæˆåŠŸæ—¥å¿—
                const logText = '=== å¸è½½æˆåŠŸ ===\n\n' + (data.output || 'å¸è½½å®Œæˆ');
                showLogModal('å¸è½½æˆåŠŸ - ' + app.name, logText, false);
                showToast('å¸è½½æˆåŠŸ', app.name + ' å·²æˆåŠŸå¸è½½', 'success');
                loadApps(); // é‡æ–°åŠ è½½åˆ—è¡¨
            } else {
                // æ˜¾ç¤ºå¤±è´¥æ—¥å¿—
                const logText = '=== å¸è½½å¤±è´¥ ===\n\n' + (data.output || data.message || 'æœªçŸ¥é”™è¯¯');
                showLogModal('å¸è½½å¤±è´¥ - ' + app.name, logText, false);
                showToast('å¸è½½å¤±è´¥', data ? data.message : 'æœªçŸ¥é”™è¯¯', 'error');
            }
        });
    }
}

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
window.addEventListener('load', function() {
    loadApps();
});
</script>

<%+footer%>
